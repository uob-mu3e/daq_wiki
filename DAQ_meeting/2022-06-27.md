# DAQ meeting

Present: *Alex,Ann-Kathrin,Konrad,Frederik,Martin,Nik,Ben,Marius,Urs,etc.*

___
## Cosmic run at PSI

- [Ben]
    - optimizing (bank decoding)
      and analyzing (takes a lot of time, but getting better)
    - preparing pipeline for ana to process all the data
    - soon will have automatic system for all the cosmic data
- [MM]
    - zero suppression implemented for cosmic data
    - analyzed 5 min of data, seems to contain more physics that without zerosup
    - need to do more tests: sorter test (if sorter looses data)
    - see about few tens of MB/s
    - started to look into data files: see where we loose data
      (sometimes sorter produces nonsense, with zerosup there is new limit)
      (with current system we loose ~50% of data - somewhere in DMA?)
    - start to write sorter error counter
      (check protocol errors or missing headers)
    - on run start we get hits from prev run
      (smth is not cleared)
    - empty frames work ok in sorter
    - pixels have not much to optimize and they are ready for data
- [MK]
    - the data is not really zerosup, as you still write some headers
    - there is no back pressure from DMA
      (write to farm and grab data, if midas is too slow then
      we can loose data due to odb timeout)
    - can do bigger DMA buffer to get more data on switch
- [AK]
    - may be try 2 simulators to see if there are any not-trivial bugs

## fb/tl DAQ workshop in Mainz

* Datapath for Scifi and Tile defined.

  Example for Scifi:

  ![scifi_data_path.png](https://bitbucket.org/repo/7zKBgbq/images/3583848254-scifi_data_path.png)

* Status Firmware Datapath:
    - MUX, Replacement for Sorter,
    - Readout of Link Data Directly Done
      [mutrig_datapath_v2](https://bitbucket.org/mu3e/online/branch/mutrig_datapath_v2)

* Record types:
    - For Scifi and Tile the hit can be stored in 32bit after the sorter.
    - Aim was to minimize the number of non timestamp bits in the sorter.
    - Also the same datapath on the SWB as for the pixels can be used with 32bits.
    - Only change for MuTrig is a second record type on the SWB.

* Sorter:
    - [MuTrig Sorting](https://bitbucket.org/mu3e/online/wiki/MuTrig%20sorting)
      was adopted with ideas from the Hackathon.

* Histograms: 

    | Histograms                   | Number of histograms | FPGA / PC    | Status |
    |------------------------------|----------------------|--------------|--------|
    | Hitmap (one bin per Channel) | Per ASIC             | SWB analyzer | Done   |
    | Distribution of fine counter | 32 times per ASIC    | SWB analyzer | Done   |

* Counters:

    | Counter                       | FPGA      | Status                |
    |-------------------------------|-----------|-----------------------|
    | Number of Frames Per ASIC     | FEB       | Done                  |
    | LVDS Errors Per ASIC          | FEB       | Done                  |
    | Number of Hits Per ASIC       | FEB       | Done                  |
    | CRC Errors	Per ASIC        | FEB       | Done                  |
    | Number of Hits Per Channel    | FEB / SWB | Done on the FEB       |
    | Sync loss Per ASIC            | FEB       | Done                  |
    | Sorter Counters               | FEB       | Done - same as Pixel  |

* Status Bits on the FEB:
    - PLL Lock, Link Lock, Sync per ASIC -> Done

* Discussion of Clustering on SWB for Scifi: 
    - MuTrig has logic for clustering of neighboring channels
        - maybe this is already enough (needs to be simulated)
    - In addition one can build a ribbon clustering pipline:
        - "Offset RAM" per channel in time -> (Fine sort to less than 8ns) ->
        - merge modules in time (should be possible by correctly connecting to the time merger) ->
        - "Offset RAM" to align channels in space -> cluster.
    - Which kind of additional clustering we need we should first simulate in software
      and than think about what gives us the best reduction.
    - In general an overall reduction by a factor of 10 is needed
      (40Gbit/s to the Farm Input to SWB order of 100GBit/s)

* Configuration:
    - Try to stay with the ODB
      (we dont have so much data - also MEG uses ODB configurations with 4000 values)
    - and try to increase the performance of odb++ API to send ODB tree from the SWB to the Backend.
    - At the moment it is one value per transaction.
    - Different possibilities to increase the performance:
        - store config already in a binary array,
        - rewrite odb++ API for allowing to send the whole tree in one transaction
```
  (SR: Das odb++ API kann ich optimieren, die ODB selber aber nicht, die ist wie sie ist.
  Du kannst mal spasseshalber eine Struktur wir wir sie später haben werden (also >10000) in der ODB anlegen,
  und dann vom Subtree ein "save test.json" machen.
  Dann siehst Du wie man den Tree von A nach B bekommen wird.
  Wenn das 10 Sekunden dauert, haben wir verloren.
```
  ->
```
  I can optimize the API but not the ODB.
  We should try to configure a ODB like we would have it for the final detector
  and try with odbedit "save test.json" on the tree and transfer the tree from A to B.
  If this takes 10 sec we need to think again about another solution.) 
```

    - NOTE: Not only a MuTrig problem -> size of all the MuTrig config is on the same size of the MuPix chip config.

* Custom pages for monitoring & Control:
    - We had a short presentation over the current pages we already have
    - the Tile people will now first integrate all values into the ODB (T,V etc.)
    - and than they will slowly start on building custom pages.

* Reset / Clock shifting for MuTrig:
    - Bachelor Student from KIP will try to implement this shift entity
      to align different chips.
    - Idea was to try the [altiobuf IP](https://www.intel.com/content/dam/support/jp/ja/programmable/support-resources/bulk-container/pdfs/literature/ug/ug-altiobuf.pdf)

* Analyzer:
    - Short discussion on what is missing for MuTrig ->
    - Do similar to pixel flow (data cleaner, clustering, mu3e root file)

* QC / Tuning:
    - Sequencer Script for threshold tuning of different channels
      was implemented and test at PSI setup is planed for this week.
    - Idea is to get the rate of each channel in firmware (block is implemented)
      and tune all channels to the lowest common threshold.
    - Values are stored as for the pixel QC tests in the ODB.

* Demo:
    - Mutrig + FEB simulation in questa:
    - KB just showed us a few lines but the plan is to have at some point a demo
      on how to simulated the mutrig asic / datapath.
    - MK has a setup for ghdl which uses ASIC data recorded from signal tab for the whole datapath.

* Structuring of subdetector software in `switch_fe`:
    - We should the changes to the `switch_fe` and KB will slowly move things
      to the MuTrig class since at the moment some parts are in `switch_fe`
      and some are in the MuTrig class.

* PLL lock tests:
    - We also played around with the MuTrig settings to find consistent settings
      for the PLL lock test.
    - One "strange" thing we observed was that MuTrig2 does have a smaller range of stable settings.
    - The baseline settings which where found for MuTrig1 did not work.
    - To further analyze this issue we should repeat some DAC scans
      with the FEB setup and the evaluation setup.
    - An example for MuTrig1 is shown here:
      ![Image Pasted at 2022-6-15 14-11.png](https://bitbucket.org/repo/7zKBgbq/images/399676339-Image%20Pasted%20at%202022-6-15%2014-11.png)

Discussion during DAQ meeting:

- [MK]
    - maybe use 2 scifi sorters
    - idea is to use 8 ns timestamps + 3 bits for remainder for finer time
    - and we keep depth of sorting same as for pixels
    - clustering can be done later on switch
- [NB]
    - looks possible
    - can trade between number of hits per timestamp and sorter depth
    - 8 ns can be beneficial for overlapping of rec frames
    - for now keep with 15 hits max per 8 ns per channel
- [NB]
    - we need conversion from/to midas/c-objects should be done
      in one place (to not duplicate same conversion in many places,
      this also is related to idmap) and we need it in some repo/code
- [MK]
    - some more test
        - sync mutrig with pixel in Mainz,
          used pin headers on fpga, send inj pulse to mutrig
          and see if two fpga's are in sync
        - see some correlation but problems due to reset not working
          (can't really do sync test -> need new working feb)

### Status and ongoing work

### TODO

* :white_check_mark:
  Set-up network including dedicated gateway, do performance tests
* :white_check_mark:
  Clear and re-cable the fibre fanout rack
* :white_check_mark:
  Recuperate the 2-3 fibres from the area
* :white_check_mark:
  Can configure MuPix from MIDAS via FEB reliably and with a MIDAS UI.
* :white_check_mark:
  Can configure MuTrig from MIDAS via FEB reliably and with a MIDAS UI.
  (can manipulate config for each asic from UI,
  but no automated test yet)

* FEB SlowControl interface works reliably (clock bug, anything else ?)
    - we should rework to use same reset sequence from test script in switch FE

* :white_check_mark:
  Have diagnostics for all links, PLLs and clocks in place, including MIDAS UI
  *Done by Nik, will need some testing*
  (see [Pixel LVDS Status](https://bitbucket.org/mu3e/online/wiki/UI/Pixel%20LVDS%20UI.md)
  and [Data Flow Page](https://bitbucket.org/mu3e/online/wiki/UI/Data%20Flow%20UI.md))

* Pixel sorter works in HW *To be tested*
    - still some missing sub-header, but can't reproduce in sim
    - need more examples of problems
* SciFi sorter works in HW *Stretch goal*

* :white_check_mark:
  We can do run starts and configs with the ODB on the backend
  (i.e. not the switch and not the farm)
    - *Looked ok for first tests without much config or subdetectors.*
      *Keep eyes open when further developing this, should stay below 1s*
    - (farm_fe only worked on second run start - seem to not happen anymore)

* :white_check_mark:
  Make clear what needs to be run to initialize a clean system
  (ODB scripts, environment scripts, DAQ starting scripts)
  (see readme in online repo)

* Investigate rsysnc/lazy logger for data transfer to Merlin, (Urs)
    - should work in principle

* :white_check_mark:
  Hook up some FEBs
* :white_check_mark:
  Flash FEBs with subdet image and emergency image
* :white_check_mark:
  (done for one FEB, need to do for all of them)
  Test FEB boot, including emergency

* Maybe MIDAS UI for emergency boot?
* Very stretch goal: Parallel FEB flashing

* :white_check_mark:
  Test MIDAS interface to crate controllers
* :white_check_mark:
  Test MIDAS link monitoring
* :white_check_mark:
  Test MIDAS PLL monitoring
* :white_check_mark:
  Finish data flow monitoring, update SSCN bank spec, hook up SSCN and user page
* :white_check_mark:
  Test data flow monitoring
* :white_check_mark:
  Test data flow
* :white_check_mark:
  ODB and user interface for LVDS link masking
  (only for some chips, not for full matrix, but is enough for cosmic run)
* :white_check_mark:
  MuPix config with big DAQ system
* :white_check_mark:
  MuTrig config with big DAQ system (with midas)
* :white_check_mark:
  Hook up environment monitoring to DAQ
  (final test for liquid cooling and it is done)
* :white_check_mark:
  Hook up power control to DAQ
* :white_check_mark:
  Hook up helium system to DAQ

* Make sure history system works
    - some data missing in history?
      (when zoom in history, there seem to be missing data)
      need to be followed on

* Define history plots, preferably in the respective FE code
  (see examples)
* Slowly get started on alarms (the clock box and temperatures therein could be a good starting point)
* :white_check_mark:
  MuPix masking from midas
    - (of individual pixel, sw is there but need to test)
    - work is in progress in Mainz, can try soon

* :white_check_mark:
  How to expose analyzer to outside word for people working remotely
    - there is custom page in onlineAna

* Some not cleared buffers (from prev run) in the system (hardware and/or software)
    - some ideas where it comes from, work is in progress

* Write manuals as you go along
* Be verbose on the elog

* combined sorter for mutrig

___
## Rest of the world

### Zürich ###

### Geneva ###

### Heidelberg Pixels ###

### Heidelberg telescope upgrade ###

### Heidelberg Tiles ###

- [KB]
    - work on midas integration
    - setting up everything, and testing
      (some problems on dev branch, outdated code)
    - go to online version and start testing, merge into online
    - broken control reset on Arria - how to proceed?
      (run prepare and sync work, but run does not)

### KIT ###

### MIDAS ###

___
## Pull requests

What can we merge? - Strategy decided, merges performed.

[Open Pull Requests](https://bitbucket.org/mu3e/online/pull-requests/?state=OPEN)

___
## Bitbucket issues

Have a look - the list is not getting shorter (yet?).
Close things that are solved.
Add issues if you discover them.
Work to tackle them ...
Use CRITCAL for issues that are needed for the cosmic run.

[Open Issues](https://bitbucket.org/mu3e/online/issues?status=new&status=open)

___
## Next week
